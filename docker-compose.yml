# Docker Compose format version is no longer required in v2

services:
  schoology-scraper:
    build: 
      context: .
      dockerfile: Dockerfile
    image: schoology-scraper:latest
    container_name: schoology-scraper
    
    # Environment variables
    environment:
      - DISPLAY=:99
      - PYTHONUNBUFFERED=1
    
    # Volume mounts for data persistence and configuration
    volumes:
      # Data persistence
      - ./data:/app/data
      - ./logs:/app/logs
      
      # Configuration (read-only)
      - ./config.toml:/app/config.toml:ro
      - ./.env:/app/.env:ro
    
    # Restart policy
    restart: unless-stopped
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Network mode (default bridge is fine)
    networks:
      - default

# Optional: for scheduled runs instead of continuous service
  schoology-scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    image: schoology-scraper:latest
    container_name: schoology-scheduler
    
    # Override command for cron-like scheduling
    command: sh -c "while true; do python main.py && sleep 3600; done"
    
    environment:
      - DISPLAY=:99
      - PYTHONUNBUFFERED=1
    
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config.toml:/app/config.toml:ro
      - ./.env:/app/.env:ro
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    
    security_opt:
      - no-new-privileges:true
    
    # This service is disabled by default - enable it instead of the main service
    # for scheduled runs rather than one-shot execution
    profiles:
      - scheduler

networks:
  default:
    driver: bridge